<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e1e1e">
  <title>Amir Roohi | File management</title>
  <link rel="icon" href="/sorce/icon/folder_settings_384px.png">
  <!-- css -->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/filemanager.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- Popper.js (dependency) -->
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <!-- Tippy.js -->
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />
  <style>
    .tippy-content{
      text-align: center;
      font-family: var(--vazir);
    }

  </style>
  </head>
<body class="File-management">
  <header>
    <section class="File-management-fillgoo">
      <img class="fillgoo-img" src="/sorce/icon/folder_settings_384px.png" alt="fillgoo">
      <h1 dir="rtl">Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„ Ù‡Ø§ÛŒ Ø³Ø±ÙˆØ± Ø¯Ø± Node.js</h1>
    </section>
    <nav class="File-management-header-navbar">
      <div class="display-flex" style="align-items: center; width:100%"><a href="/filemanager" class="a-button-icon"><div class="icon x-home-p"></div></a><span id="currentPath"><%= currentPath %></span></div>
    <div id="file-actions" style="display: flex; gap: 8px; margin-bottom: 12px;">
      <button id="pasteButton" onclick="pasteFiles()" style="display: none;"><div class="icon x-paste"></button>
      <button onclick="copySelected()" disabled id="btn-copy"><div class="icon x-copy"></button>
      <button onclick="moveSelected()" disabled id="btn-move"><div class="icon x-move"></button>
      <button onclick="deleteSelected()" disabled id="btn-delete"><div class="icon x-delete"></button>
      <button onclick="renameSelected()" disabled id="btn-rename"><div class="icon x-rename"></div></button>

      <span class="x-sp"></span>
      <button onclick="createFolder()"><div class="icon x-new-folder"></div></button>
      <button onclick="createFile()"><div class="icon x-new-file"></button>
      <span class="x-sp"></span>
      <button onclick="downloadSelected()" disabled id="btn-download"><div class="icon x-download"></button>
      <label for="upload-file" class="btn-upload">Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</label>
      <input type="file" id="upload-file" style="display: none" onchange="uploadFile()" />
    </div>
    
    </nav>
  </header>
  <section class="File-management-body">
  <ul style="margin-bottom: 50px;" id="fileList"><div class="loaderl37"></div></ul>
  </section>
  <div class="File-management-context">
    <ul id="context-menu" style="display: none;">
      <li onclick="contextDownload()"><div class="icon x-download"></div> Ø¯Ø§Ù†Ù„ÙˆØ¯</li>
    <li onclick="contextCopyPath()"><div class="icon x-path"></div> Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú© </li>
    <li onclick="contextCopy()"><div class="icon x-copy"></div> Ú©Ù¾ÛŒ</li>
    <li onclick="contextMove()"><div class="icon x-move"></div> Ø§Ù†ØªÙ‚Ø§Ù„</li>
    <li onclick="contextRename()"><div class="icon x-rename"></div> ØªØºÛŒÛŒØ± Ù†Ø§Ù…</li>
    <li onclick="contextDelete()"><div class="icon x-delete"></div> Ø­Ø°Ù</li>
    <li onclick="toggleInfoPanel()" id="btn-info" disabled><div class="icon x-info"></div>Ù…Ø´Ø®ØµØ§Øª</li>
  </ul>
  
  <div id="infoPanel" style="display: none;">
    <button class="icon x-close infoPanel-close" onclick="closeInfoPanel()"></button>    
    <h4 style="margin: 0 0 10px;">Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„</h4>
    <div id="infoContent">Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>
  </div>
  </div>
  
  <div class="loadingPanel">
    <div class="loaderl37"></div>
  </div>
<script>  
    function closeInfoPanel() {
  document.getElementById('infoPanel').style.display = 'none';
}

    function toggleInfoPanel() {
  const panel = document.getElementById('infoPanel');
  if (panel.style.display === 'none') {
    updateInfoPanel();
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

function updateInfoPanel() {
  const content = document.getElementById('infoContent');
  if (selectedFiles.length === 0) {
    content.innerHTML = 'Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡';
    return;
  }

  const list = selectedFiles.map(path => {
    const name = path.split('/').pop();
    const ext = name.includes('.') ? name.split('.').pop().toLowerCase() : '';
    const fileUrl = encodeURI(path); // Ø¨Ø±Ø§ÛŒ Ø¢Ø¯Ø±Ø³â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„

    let previewHTML = '';

    if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(ext)) {
      // ğŸ“· Ø¹Ú©Ø³
      previewHTML = `<img src="${fileUrl}" alt="${name}" style="max-width: 100%; border-radius: 6px; margin: 10px 0;">`;
    } else if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
      // ğŸ¥ ÙˆÛŒØ¯ÛŒÙˆ
      previewHTML = `
        <video controls style="width: 100%; border-radius: 6px; margin: 10px 0;">
          <source src="${fileUrl}" type="video/${ext === 'mov' ? 'quicktime' : ext}">
          Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ÙˆÛŒØ¯ÛŒÙˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        </video>`;
    } else if (['mp3', 'wav', 'ogg', 'aac', 'flac'].includes(ext)) {
      // ğŸµ Ù…ÙˆØ²ÛŒÚ©
      previewHTML = `
        <audio controls style="width: 100%; margin: 10px 0;">
          <source src="${fileUrl}" type="audio/${ext}">
          Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù¾Ø®Ø´ ØµÙˆØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        </audio>`;
    }

    return `
    <li class="infoPanel-text" style="margin-bottom: 20px; width: 100%;">
      <strong style="margin-left:5px">${name}</strong><br>
      ${previewHTML}
      <div style="display: flex; align-items: center;"><div class="icon x-file"></div> Ù†ÙˆØ¹: ${ext || 'Ù¾ÙˆØ´Ù‡'}</div>
    </li>`;
  });

  content.innerHTML = `<ul style="padding-right: 16px; list-style: none; padding-left: 0;">${list.join('')}</ul>`;
}


  </script>
  
  
  <script>
    tippy('#pasteButton', {
      content: 'Ú†Ø³Ø¨Ø§Ù†Ø¯Ù† : Ù…ÙˆØ§Ø±Ø¯ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ú©Ù¾ÛŒ ÛŒØ§ Ø§Ù†ØªÙ‚Ø§Ù„ Ø²Ø¯Ù‡ Ø§ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø³ÛŒØ± Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('#btn-copy', {
      content: 'Ú©Ù¾ÛŒ : Ù¾ÙˆØ´Ù‡ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú†Ø³Ø¨Ø§Ù†Ø¯Ù† Ø¯Ø± Ù…Ø³ÛŒØ± Ø¯ÛŒÚ¯Ø± Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('#btn-move', {
      content: 'Ø§Ù†ØªÙ‚Ø§Ù„ : Ù¾ÙˆØ´Ù‡ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø¯ÛŒÚ¯Ø± Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('#btn-delete', {
      content: 'Ø­Ø°Ù : ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ ÛŒØ§ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('#btn-rename', {
      content: 'ØªØºÛŒÛŒØ± Ù†Ø§Ù…: Ù†Ø§Ù… ÙØ§ÛŒÙ„ ÛŒØ§ Ù¾ÙˆØ´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('.x-new-folder', {
      content: 'Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø¬Ø¯ÛŒØ¯: ÛŒÚ© Ù¾ÙˆØ´Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('.x-new-file', {
      content: 'Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯: ÛŒÚ© ÙØ§ÛŒÙ„ Ø®Ø§Ù„ÛŒ Ø¯Ø± Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('.btn-upload', {
      content: 'Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„: ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø² Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù…Ø³ÛŒØ± ÙØ¹Ù„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  
    tippy('#btn-download', {
      content: 'Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„: ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯',
      animation: 'scale',
      theme: 'light',
      delay: [500, 200], 
      placement: 'bottom',
    });
  </script>
  
 <script>
  let selectedFiles = [];

  function toggleSelection(elem, name, isDirectory) {
  const fullPath = currentPath + '/' + name;
  const index = selectedFiles.indexOf(fullPath);

  if (index > -1) {
    selectedFiles.splice(index, 1);
    elem.classList.remove('selected');
  } else {
    selectedFiles.push(fullPath);
    elem.classList.add('selected');
  }
  if (document.getElementById('infoPanel').style.display === 'block') {
  updateInfoPanel();
}

  

  updateActionButtons();
}


  function updateActionButtons() {
    const hasSelection = selectedFiles.length > 0;
    document.getElementById('btn-copy').disabled = !hasSelection;
    document.getElementById('btn-move').disabled = !hasSelection;
    document.getElementById('btn-delete').disabled = !hasSelection;
    document.getElementById('btn-download').disabled = !hasSelection;
    document.getElementById('btn-rename').disabled = selectedFiles.length !== 1;
    document.getElementById('btn-info').disabled = !hasSelection;

  }
  
</script>
<script>
  let clipboard = {
  action: null, // 'copy' or 'move'
  files: []
};

  
function moveSelected() {
  clipboard = {
    action: 'move',
    files: [...selectedFiles]
  };
  document.getElementById('pasteButton').style.display = 'inline-block';
  createMessage({
                  text: 'ÙˆØ§Ø±Ø¯ Ù…Ø³ÛŒØ± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø´Ùˆ Ùˆ Paste Ø¨Ø²Ù†.',
                  type: 'info',
                  timer: 3,
                  backcolor: '#252524',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });

                 
  fetch('/api/filemanager/move', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      from: selectedFiles[0], // ÙÙ‚Ø· ÛŒÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ ÙØ¹Ù„Ø§Ù‹
      to: to + '/' + selectedFiles[0].split('/').pop()
    })
  }).then(r => r.json()).then(res => {
    if (res.success) location.reload();
    else {
      createMessage({
                  text: `Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªÙ‚Ø§Ù„`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    }
  });
  }

function copySelected() {
  sessionStorage.setItem('copyFiles', JSON.stringify(selectedFiles));
  clipboard = {
    action: 'copy',
    files: [...selectedFiles]
  };
  document.getElementById('pasteButton').style.display = 'inline-block';
  createMessage({
                  text: 'ÙˆØ§Ø±Ø¯ Ù…Ø³ÛŒØ± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø´Ùˆ Ùˆ Paste Ø¨Ø²Ù†.',
                  type: 'info',
                  timer: 3,
                  backcolor: '#252524',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
}

function createFolder() {
  const name = prompt('Ù†Ø§Ù… Ù¾ÙˆØ´Ù‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');
  if (!name) return;

  fetch('/api/filemanager/mkdir', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path: currentPath, name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) loadFiles(currentPath);
    else alert(data.error || 'Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯!');
  });
}

function createFile() {
  const name = prompt('Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ new.txt):');
  if (!name) return;

  fetch('/api/filemanager/create-file', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path: currentPath, name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) loadFiles(currentPath);
    else alert(data.error || 'Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯!');
  });
}
function createFile() {
  const name = prompt('Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ new.txt):');
  if (!name) return;

  fetch('/api/filemanager/create-file', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ path: currentPath, name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) loadFiles(currentPath);
    else {
      createMessage({
                  text: `Ø³Ø§Ø®Øª ÙØ§ÛŒÙ„ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    }
  });
}


function deleteSelected() {
  if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ')) return;

  fetch('/api/filemanager?path=' + encodeURIComponent(selectedFiles[0]), {
    method: 'DELETE'
  }).then(r => r.json()).then(res => {
    if (res.success) location.reload();
    else {
      createMessage({
                  text: `Ø­Ø°Ù Ù†Ø´Ø¯.`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    }
  });
}

function renameSelected() {
  if (selectedFiles.length !== 1) return;

  const oldPath = selectedFiles[0];
  const nameOnly = oldPath.split('/').pop();
  const newName = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:', nameOnly);
  if (!newName || newName === nameOnly) return;

  const newPath = oldPath.split('/').slice(0, -1).join('/') + '/' + newName;

  fetch('/api/filemanager/rename', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      oldPath,
      newPath
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) loadFiles(currentPath);
    else {
      createMessage({
                  text: data.error || 'ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯!',
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    }
  });
}
function contextRename() {
  if (!contextTarget || !contextTarget.fileName) return;

  const oldName = contextTarget.fileName;
  const newName = prompt('Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:', oldName);
  if (!newName || newName === oldName) return;

  const oldPath = currentPath + '/' + oldName;
  const newPath = currentPath + '/' + newName;

  fetch('/api/filemanager/rename', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      oldPath,
      newPath
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      loadFiles(currentPath);
    } else {
      createMessage({
                  text: data.error || 'ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!',
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    }
  });

  contextMenu.style.display = 'none';
}



function uploadFile() {
  document.querySelector('.loadingPanel').style.display = "flex";

  const file = document.getElementById('upload-file').files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append('file', file);

  fetch('/api/filemanager/upload?path=' + encodeURIComponent(currentPath), {
    method: 'POST',
    body: formData
  }).then(r => r.json()).then(res => {
    if (res.success) location.reload();
    else {
      createMessage({
                  text: `Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    }
  });
}

function downloadSelected() {
  if (selectedFiles.length !== 1) {
    createMessage({
                  text: `ÙÙ‚Ø· ÛŒÚ© ÙØ§ÛŒÙ„ Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…ÛŒ Ø¨Ø§Ø´Ø¯.`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    return;
  }
  window.location.href = '/api/filemanager/download?path=' + encodeURIComponent(selectedFiles[0]);
}

function pasteFiles() {
  if (!clipboard.action || clipboard.files.length === 0) return;

  fetch('/api/filemanager/paste', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      files: clipboard.files,
      targetPath: currentPath,
      operation: clipboard.action
    })
  })
  .then(res => res.json())
  .then(result => {
    if (result.success) {
      clipboard = { action: null, files: [] };
      document.getElementById('pasteButton').style.display = 'none';
      loadFiles(currentPath);
    } else {
      alert(result.error || 'Paste failed');
    }
  });
}

function contextCopy() {
  clipboard = {
    action: 'copy',
    files: [...selectedFiles]
  };
  createMessage({
                  text: 'Ú©Ù¾ÛŒ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ø¯Ø§Ø®Ù„ Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ Ø±Ø§Ø³Øªâ€ŒÚ©Ù„ÛŒÚ© Ùˆ Paste Ú©Ù†.',
                  type: 'info',
                  timer: 3,
                  backcolor: '#252524',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
  contextMenu.style.display = 'none';
}

function contextMove() {
  clipboard = {
    action: 'move',
    files: [...selectedFiles]
  };
  createMessage({
                  text: `ÙˆØ§Ø±Ø¯ Ù…Ø³ÛŒØ± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø´ÙˆÛŒØ¯ Ùˆ Paste Ø±Ø§ Ø¨Ø²Ù†.`,
                  type: 'info',
                  timer: 4,
                  backcolor: '#252524',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
  contextMenu.style.display = 'none';
}

function contextDownload() {
  if (selectedFiles.length !== 1) return alert('ÙÙ‚Ø· ÛŒÚ©ÛŒ Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡!');
  window.location.href = '/api/filemanager/download?path=' + encodeURIComponent(selectedFiles[0]);
  contextMenu.style.display = 'none';
}

function contextDelete() {
  if (!confirm('Ù…Ø·Ù…Ø¦Ù†ÛŒ Ø­Ø°Ù Ø¨Ø´Ù‡ØŸ')) return;
  fetch('/api/filemanager?path=' + encodeURIComponent(selectedFiles[0]), {
    method: 'DELETE'
  }).then(res => res.json()).then(res => {
    if (res.success) loadFiles(currentPath);
    else { createMessage({
                  text: `Ø­Ø°Ù Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });}
  });
  contextMenu.style.display = 'none';
}

</script>
<script>
  const contextMenu = document.getElementById('context-menu');
let contextTarget = null;

document.addEventListener('click', () => {
  contextMenu.style.display = 'none';
});

function showContextMenu(event, elem, fileName, isDirectory) {
  event.preventDefault();
  contextTarget = { elem, fileName, isDirectory };
  
  const fullPath = currentPath + '/' + fileName;
  if (!selectedFiles.includes(fullPath)) {
    selectedFiles = [fullPath];
    document.querySelectorAll('.selected').forEach(e => e.classList.remove('selected'));
    elem.classList.add('selected');
  }

  updateActionButtons();

  contextMenu.style.top = event.pageY + 'px';
  contextMenu.style.left = event.pageX + 'px';
  contextMenu.style.display = 'block';
}

function contextCopyPath() {
  if (!contextTarget || !contextTarget.fileName) return;

  const fullPath =  currentPath + '/' + contextTarget.fileName;

  navigator.clipboard.writeText(fullPath)
    .then(() => {
      createMessage({
                  text: `Ù…Ø³ÛŒØ± Ø¯Ø± Ú©Ù„ÛŒÙ¾Ø¨ÙˆØ±Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯.`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#252524',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    })
    .catch(err => {
      console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ù…Ø³ÛŒØ±:', err);
      createMessage({
                  text: `Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ`,
                  type: 'info',
                  timer: 3,
                  backcolor: '#aa2101',
                  color: '#fff',
                  image: '/sorce/icon/high_priority_message_480px.png',
                  location: 'top',
                  align: 'center',
                });
    });

  contextMenu.style.display = 'none';
}

</script>
<script>
  const fileList = document.getElementById('fileList');
const currentPathSpan = document.getElementById('currentPath');
const urlParams = new URLSearchParams(window.location.search);

let currentPath = urlParams.get('path') || '/';

// Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ \ Ø¨Ø§ /
currentPath = currentPath.replace(/\\/g, '/');

if (!currentPath.startsWith('/')) {
currentPath = '/' + currentPath;
}

console.log('Current Path:', currentPath);

function loadFiles(path) {
  fetch(`/api/filemanager/files?path=${encodeURIComponent(path)}`)
    .then(res => res.json())
    .then(data => {
      // ğŸ¯ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§:
      selectedFiles = [];
      updateActionButtons();

      currentPath = data.path;
      currentPathSpan.textContent = currentPath;
      fileList.innerHTML = '';
      
      const newUrl = `/filemanager?path=${encodeURIComponent(currentPath)}`;
      history.pushState(null, '', newUrl);

      if (currentPath !== '/') {
        const upPath = currentPath.split('/').slice(0, -1).join('/') || '/';
        const upLi = document.createElement('li');
        upLi.innerHTML = `<div class="display-flex" style="align-items: center;"><div class="icon x-back-p"></div><a href="#" style="width: 100%;" onclick="loadFiles('${upPath}')"> .. Ø¨Ø§Ø²Ú¯Ø´Øª</a></div>`;
        fileList.appendChild(upLi);
      }

      data.files.forEach(file => {
        const li = document.createElement('li');
        li.setAttribute('data-name', file.name);

        if (file.isDirectory) {
  li.className = 'folder';
  const nextPath = (currentPath === '/' ? '' : currentPath) + '/' + file.name;
  
  const iconHTML = file.customIcon
    ? `<img src="${file.customIcon}" style="width: 20px; height: 20px; border-radius: 4px; margin-left: 5px;">`
    : `<div class="icon x-folder a-${file.name}"></div>`;
    
  li.innerHTML = `${iconHTML}<a href="#" onclick="event.stopPropagation(); loadFiles('${nextPath}')">${file.name}</a>`;
}
 else {
          li.className = 'file';
          const fileUrl = (currentPath === '/' ? '' : currentPath) + '/' + file.name;
           // Ú¯Ø±ÙØªÙ† Ù¾Ø³ÙˆÙ†Ø¯ ÙØ§ÛŒÙ„
          const extension = file.name.includes('.') ? '.' + file.name.split('.').pop() : '';
          const nameWithoutExtension = file.name.includes('.') ? file.name.split('.').pop() : '';
          li.innerHTML = `<div class="icon x-file a-${nameWithoutExtension}"></div> <a href="${fileUrl}" target="_blank" onclick="event.stopPropagation();">${file.name}</a>`;
        }
        li.oncontextmenu = (event) => showContextMenu(event, li, file.name, file.isDirectory);
        li.onclick = () => toggleSelection(li, file.name, file.isDirectory);
        fileList.appendChild(li); 
      });

    })
    .catch(error => {
      console.error("File loading error:", error);
    });
}

loadFiles(currentPath);

</script>

<footer dir="rtl">
  Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· Amir Roohi(hitter356)
</footer>
    </body>
    <script src="/Js/message-fiilgoo-v1.js"></script>

</html>
